<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panneau Admin – Gestion des Lots</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      padding: 2rem;
      margin: 0;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    .login, .admin-panel {
      max-width: 600px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    input, button {
      width: 100%;
      padding: 0.8rem;
      margin: 0.5rem 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    button:hover {
      background: #218838;
    }
    .lot-item {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #f9f9f9;
    }
    .modif {
      background: #ffc107;
      color: black;
    }
    .modif:hover {
      background: #e0a800;
    }
    .delete {
      background: #dc3545;
    }
    .delete:hover {
      background: #b02a37;
    }
    #loginError {
      color: red;
      display: none;
      text-align: center;
    }
    #sauvegardeStatus {
      color: green;
      text-align: center;
      height: 20px;
    }
  </style>
</head>
<body>

  <!-- Connexion admin -->
  <div class="login" id="loginSection">
    <h1>🔐 Connexion Admin</h1>
    <input type="password" id="adminPass" placeholder="Mot de passe admin">
    <button id="loginBtn">Connexion</button>
    <p id="loginError">Mot de passe incorrect.</p>
  </div>

  <!-- Panneau Admin -->
  <div class="admin-panel" id="adminPanel" style="display: none;">
    <h1>🎛️ Gestion des lots</h1>

    <input type="text" id="lotNom" placeholder="Nom du lot">
    <input type="text" id="lotImage" placeholder="URL de l'image">
    <input type="number" id="lotPrix" placeholder="Prix du ticket (€)">
    <input type="number" id="lotTotalTickets" placeholder="Nombre total de tickets">
    <input type="datetime-local" id="lotDate" placeholder="Date du tirage">
    <button id="addBtn">Ajouter le lot</button>
    <a href="participants.html" target="_blank" style="display: block; text-align: center; margin-top: 1rem;">
      Voir la liste des participants
    </a>

    <h2>Lots actuels</h2>
    <div id="listeLots"></div>
    <p id="sauvegardeStatus"></p>
  </div>

  <script>
    // Détermination de l'URL de l'API
    const BACKEND_URL = window.location.hostname === "localhost"
      ? "http://localhost:3000"
      : "https://tirage-tvdv.onrender.com";

    console.log("BACKEND_URL =", BACKEND_URL);

    let lots = [];
    let indexEnModif = null;
    let sessionPassword = null;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").addEventListener("click", login);
      document.getElementById("addBtn").addEventListener("click", ajouterOuModifierLot);
    });

    async function login() {
      const pass = document.getElementById("adminPass").value;
      const errorP = document.getElementById("loginError");
      errorP.style.display = "none";
      console.log("Tentative de login avec:", pass);

      try {
        const res = await fetch(`${BACKEND_URL}/api/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pass })
        });
        console.log("Réponse login status:", res.status);

        if (!res.ok) throw new Error("Login failed");

        sessionPassword = pass;
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        chargerLots();
      } catch (err) {
        console.error("Erreur login:", err);
        errorP.style.display = "block";
      }
    }

    async function chargerLots() {
      console.log("Chargement des lots...");
      try {
        const res = await fetch(`${BACKEND_URL}/api/lots`);
        if (!res.ok) {
          // Si la base de données est vide (ex: 404), on initialise avec un tableau vide.
          lots = [];
        } else {
          const data = await res.json();
          // Le backend peut renvoyer un objet {lots: [...]}, on ne garde que le tableau.
          lots = Array.isArray(data) ? data : data.lots || [];
        }
        console.log("Lots reçus:", lots);
        afficherLots();
      } catch (err) {
        console.error("Erreur lors du chargement des lots:", err);
        lots = []; // En cas d'erreur (ex: JSON malformé), on repart de zéro.
        afficherLots();
      }
    }

    function afficherLots() {
      const container = document.getElementById("listeLots");
      container.innerHTML = "";
      lots.forEach(lot => {
        const div = document.createElement("div");
        div.className = "lot-item";
        div.innerHTML = `
          <strong>${lot.nom}</strong><br>
          <img src="${lot.image}" alt="${lot.nom}" style="width:100%;max-height:200px;object-fit:cover;"><br>
          🎟️ ${lot.prix} €<br>
          🎫 Total Tickets: ${lot.totalTickets}<br>
          📅 Tirage: ${lot.date}<br>
          <button class="modif">Modifier</button>
          <button class="delete">Supprimer</button>
        `;
        // Events modifier / supprimer
        div.querySelector(".modif").addEventListener("click", () => startModifLot(lot.id));
        div.querySelector(".delete").addEventListener("click", () => supprimerLot(lot.id));
        container.appendChild(div);
      });
    }

    function startModifLot(id) {
      indexEnModif = lots.findIndex(l => l.id === id);
      const lot = lots[indexEnModif];
      document.getElementById("lotNom").value = lot.nom;
      document.getElementById("lotImage").value = lot.image;
      document.getElementById("lotPrix").value = lot.prix;
      document.getElementById("lotTotalTickets").value = lot.totalTickets;
      document.getElementById("lotDate").value = lot.date;
      document.getElementById("addBtn").textContent = "Modifier le lot";
    }

    async function supprimerLot(id) {
      if (!confirm("Êtes-vous sûr de vouloir supprimer ce lot ? Cette action est irréversible.")) return;
      lots = lots.filter(l => l.id !== id);
      afficherLots();
      await sauvegarderLots();
    }

    async function ajouterOuModifierLot() {
      const nom = document.getElementById("lotNom").value.trim();
      const image = document.getElementById("lotImage").value.trim();
      const prix = document.getElementById("lotPrix").value;
      const total = document.getElementById("lotTotalTickets").value;
      const date = document.getElementById("lotDate").value;

      if (!nom || !image || !prix || !total || !date) {
        alert("⚠️ Tous les champs sont requis !");
        return;
      }

      const lotData = {
        nom,
        image,
        prix,
        totalTickets: parseInt(total, 10),
        date
      };

      if (indexEnModif !== null) {
        lotData.id = lots[indexEnModif].id;
        lots[indexEnModif] = lotData;
        indexEnModif = null;
        document.getElementById("addBtn").textContent = "Ajouter le lot";
      } else {
        lotData.id = `lot_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
        lots.push(lotData);
      }

      afficherLots();
      await sauvegarderLots();

      // reset form
      ["lotNom","lotImage","lotPrix","lotTotalTickets","lotDate"].forEach(id=> {
        document.getElementById(id).value = "";
      });
    }

    async function sauvegarderLots() {
      if (!sessionPassword) {
        alert("Session expirée. Veuillez vous reconnecter pour sauvegarder les modifications.");
        return;
      }

      const statusP = document.getElementById("sauvegardeStatus");
      statusP.textContent = "💾 Sauvegarde en cours...";
      console.log("Envoi lots au serveur:", lots);

      try {
        const res = await fetch(`${BACKEND_URL}/api/lots`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // On envoie le mot de passe pour l'authentification côté backend
          body: JSON.stringify({ lots: lots, password: sessionPassword })
        });
        if (!res.ok) {
          const errorBody = await res.json().catch(() => ({ message: "Réponse invalide du serveur" }));
          throw new Error(errorBody.message || "Erreur lors de la sauvegarde");
        }
        statusP.textContent = "✅ Lots sauvegardés";
        setTimeout(() => { statusP.textContent = ""; }, 3000);
      } catch (err) {
        console.error("Erreur sauvegarde:", err);
        statusP.textContent = `❌ Échec de la sauvegarde: ${err.message}`;
      }
    }
  </script>
</body>
</html>
